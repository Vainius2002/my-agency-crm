{% extends "base.html" %}

{% block title %}Contacts - Agency CRM{% endblock %}

{% block content %}
<div class="pb-5 border-b border-gray-200 sm:flex sm:items-center sm:justify-between">
    <h3 class="text-2xl font-semibold leading-6 text-gray-900">Client Contacts</h3>
    <div class="mt-3 sm:mt-0 sm:ml-4 space-x-3">
        <a href="{{ url_for('clients.export_contacts') }}" class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
            <i class="fas fa-file-excel mr-2"></i> Export to Excel
        </a>
        <a href="{{ url_for('clients.new_contact') }}" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700">
            <i class="fas fa-plus mr-2"></i> New Contact
        </a>
    </div>
</div>

<div class="mt-6">
    <form method="GET" action="{{ url_for('clients.contacts') }}" class="bg-white p-4 rounded-lg shadow">
        <div class="grid grid-cols-1 gap-4 sm:grid-cols-5">
            <div>
                <label for="search" class="block text-sm font-medium text-gray-700">Search</label>
                <input type="text" id="search" name="search" value="{{ search_query }}" 
                       placeholder="Name, email, or phone..."
                       class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
            </div>
            
            <div>
                <label for="contact_type" class="block text-sm font-medium text-gray-700">Filter by Type</label>
                <select id="contact_type" name="contact_type" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                    <option value="">All Types</option>
                    <option value="client" {% if selected_contact_type == 'client' %}selected{% endif %}>Client</option>
                    <option value="partner" {% if selected_contact_type == 'partner' %}selected{% endif %}>Partner</option>
                    <option value="media" {% if selected_contact_type == 'media' %}selected{% endif %}>Media</option>
                </select>
            </div>
            
            <div>
                <label for="brand_id" class="block text-sm font-medium text-gray-700">Filter by Brand</label>
                <select id="brand_id" name="brand_id" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                    <option value="">All Brands</option>
                    {% for brand in brands %}
                    <option value="{{ brand.id }}" {% if selected_brand_id == brand.id %}selected{% endif %}>
                        {{ brand.name }} ({{ brand.company.name }})
                    </option>
                    {% endfor %}
                </select>
            </div>
            
            <div>
                <label for="company_id" class="block text-sm font-medium text-gray-700">Filter by Company</label>
                <select id="company_id" name="company_id" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                    <option value="">All Companies</option>
                    {% for company in companies %}
                    <option value="{{ company.id }}" {% if selected_company_id == company.id %}selected{% endif %}>
                        {{ company.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="flex items-end space-x-2">
                <button type="submit" class="inline-flex items-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50">
                    <i class="fas fa-search mr-2"></i> Search
                </button>
                {% if search_query or selected_brand_id or selected_company_id or selected_contact_type %}
                <a href="{{ url_for('clients.contacts') }}" class="inline-flex items-center px-4 py-2 text-sm text-gray-500 hover:text-gray-700">
                    Clear
                </a>
                {% endif %}
            </div>
        </div>
    </form>
</div>

<div class="mt-6">
    <div class="overflow-hidden bg-white shadow sm:rounded-md">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Contact</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Brands</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Responsibility</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Contact Info</th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                    <th scope="col" class="relative px-6 py-3"><span class="sr-only">Actions</span></th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                {% for contact in contacts %}
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex items-center">
                            <div class="flex-shrink-0">
                                <div class="h-10 w-10 rounded-full bg-gray-400 flex items-center justify-center">
                                    <span class="text-white font-medium text-sm">{{ contact.first_name[0] }}{{ contact.last_name[0] }}</span>
                                </div>
                            </div>
                            <div class="ml-4">
                                <div class="text-sm font-medium text-gray-900">{{ contact.first_name }} {{ contact.last_name }}</div>
                                <div class="text-sm text-gray-500">
                                    {% if contact.birthday_month and contact.birthday_day %}
                                        <i class="fas fa-birthday-cake text-gray-400 mr-1"></i> 
                                        {% set months = ['', 'Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'] %}
                                        {{ months[contact.birthday_month] }} {{ contact.birthday_day }}
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        {% if contact.contact_type == 'client' %}
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                Client
                            </span>
                        {% elif contact.contact_type == 'partner' %}
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-purple-100 text-purple-800">
                                Partner
                            </span>
                        {% elif contact.contact_type == 'media' %}
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">
                                Media
                            </span>
                        {% else %}
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                                Client
                            </span>
                        {% endif %}
                    </td>
                    <td class="px-6 py-4">
                        <div class="flex flex-wrap gap-1 max-w-xs">
                            {% for brand in contact.brands %}
                                <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-800">
                                    {{ brand.name }}
                                </span>
                            {% else %}
                                <span class="text-sm text-gray-400">No brands</span>
                            {% endfor %}
                        </div>
                    </td>
                    <td class="px-6 py-4">
                        <div class="text-sm text-gray-900 max-w-xs truncate">
                            {% if contact.responsibility_description %}
                                {{ contact.responsibility_description|truncate(60) }}
                            {% else %}
                                <span class="text-gray-400">-</span>
                            {% endif %}
                        </div>
                    </td>
                    <td class="px-6 py-4">
                        <div class="text-sm">
                            <div class="text-gray-900">{{ contact.email }}</div>
                            {% if contact.phone %}
                                <div class="text-gray-500">{{ contact.phone }}</div>
                            {% endif %}
                            <div class="flex items-center space-x-2 mt-1">
                                {% if contact.should_get_gift %}
                                    <span class="text-yellow-500" title="Gets gift">
                                        <i class="fas fa-gift"></i>
                                    </span>
                                {% endif %}
                                {% if contact.receive_newsletter %}
                                    <span class="text-blue-500" title="Receives newsletter">
                                        <i class="fas fa-envelope"></i>
                                    </span>
                                {% endif %}
                                {% if contact.linkedin_url %}
                                    <a href="{{ contact.linkedin_url }}" target="_blank" class="text-blue-600" title="LinkedIn">
                                        <i class="fab fa-linkedin"></i>
                                    </a>
                                {% endif %}
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        {% if contact.status == 'active' %}
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                Active
                            </span>
                        {% else %}
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                                Passive
                            </span>
                        {% endif %}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <a href="{{ url_for('clients.contact_detail', contact_id=contact.id) }}" class="text-indigo-600 hover:text-indigo-900">View</a>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="6" class="px-6 py-4 text-center text-sm text-gray-500">No contacts found. Create your first contact to get started.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Pagination -->
{% if pagination and pagination.pages > 1 %}
<div class="mt-6 px-4 py-3 flex items-center justify-between border-t border-gray-200 sm:px-6">
    <div class="flex-1 flex justify-between sm:hidden">
        {% if pagination.has_prev %}
        <a href="{{ url_for('clients.contacts', page=pagination.prev_num, search=search_query, brand_id=selected_brand_id, company_id=selected_company_id) }}" class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
            Previous
        </a>
        {% endif %}
        {% if pagination.has_next %}
        <a href="{{ url_for('clients.contacts', page=pagination.next_num, search=search_query, brand_id=selected_brand_id, company_id=selected_company_id) }}" class="ml-3 relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
            Next
        </a>
        {% endif %}
    </div>
    <div class="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between">
        <div>
            <p class="text-sm text-gray-700">
                Showing
                <span class="font-medium">{{ ((pagination.page - 1) * pagination.per_page) + 1 }}</span>
                to
                <span class="font-medium">{{ ((pagination.page - 1) * pagination.per_page) + pagination.items|length }}</span>
                of
                <span class="font-medium">{{ pagination.total }}</span>
                results
            </p>
        </div>
        <div>
            <nav class="relative z-0 inline-flex rounded-md shadow-sm -space-x-px" aria-label="Pagination">
                {% if pagination.has_prev %}
                <a href="{{ url_for('clients.contacts', page=1, search=search_query, brand_id=selected_brand_id, company_id=selected_company_id) }}" class="relative inline-flex items-center px-2 py-2 rounded-l-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                    <span class="sr-only">First</span>
                    <i class="fas fa-angle-double-left"></i>
                </a>
                <a href="{{ url_for('clients.contacts', page=pagination.prev_num, search=search_query, brand_id=selected_brand_id, company_id=selected_company_id) }}" class="relative inline-flex items-center px-2 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                    <span class="sr-only">Previous</span>
                    <i class="fas fa-angle-left"></i>
                </a>
                {% endif %}
                
                {% for page_num in pagination.iter_pages(left_edge=1, left_current=1, right_current=2, right_edge=1) %}
                    {% if page_num %}
                        {% if page_num != pagination.page %}
                            <a href="{{ url_for('clients.contacts', page=page_num, search=search_query, brand_id=selected_brand_id, company_id=selected_company_id) }}" class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50">
                                {{ page_num }}
                            </a>
                        {% else %}
                            <span class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-indigo-50 text-sm font-medium text-indigo-600">
                                {{ page_num }}
                            </span>
                        {% endif %}
                    {% else %}
                        <span class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-700">...</span>
                    {% endif %}
                {% endfor %}
                
                {% if pagination.has_next %}
                <a href="{{ url_for('clients.contacts', page=pagination.next_num, search=search_query, brand_id=selected_brand_id, company_id=selected_company_id) }}" class="relative inline-flex items-center px-2 py-2 border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                    <span class="sr-only">Next</span>
                    <i class="fas fa-angle-right"></i>
                </a>
                <a href="{{ url_for('clients.contacts', page=pagination.pages, search=search_query, brand_id=selected_brand_id, company_id=selected_company_id) }}" class="relative inline-flex items-center px-2 py-2 rounded-r-md border border-gray-300 bg-white text-sm font-medium text-gray-500 hover:bg-gray-50">
                    <span class="sr-only">Last</span>
                    <i class="fas fa-angle-double-right"></i>
                </a>
                {% endif %}
            </nav>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}