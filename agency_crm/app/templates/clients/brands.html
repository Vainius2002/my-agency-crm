{% extends "base.html" %}

{% block title %}Brands - Agency CRM{% endblock %}

{% block content %}
<div class="pb-5 border-b border-gray-200 sm:flex sm:items-center sm:justify-between">
    <h3 class="text-2xl font-semibold leading-6 text-gray-900">Brands</h3>
    <div class="mt-3 sm:mt-0 sm:ml-4 space-x-3">
        <a href="{{ url_for('clients.export_brands') }}" class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
            <i class="fas fa-file-excel mr-2"></i> Export to Excel
        </a>
        <a href="{{ url_for('clients.new_brand') }}" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700">
            <i class="fas fa-plus mr-2"></i> New Brand
        </a>
    </div>
</div>

<!-- Filter Section -->
<div class="mt-6 bg-white shadow sm:rounded-lg p-4">
    <div class="grid grid-cols-1 gap-4 sm:grid-cols-3">
        <div>
            <label for="search" class="block text-sm font-medium text-gray-700">Search</label>
            <input type="text" id="search" placeholder="Search company, brand, or subbrand..." 
                   class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
        </div>
        <div>
            <label for="keyPerson" class="block text-sm font-medium text-gray-700">Key Person</label>
            <select id="keyPerson" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                <option value="">All Key Persons</option>
                {% set key_persons = [] %}
                {% for brand in brands %}
                    {% set key_person = brand.team_members|selectattr('is_key_responsible', 'equalto', true)|first %}
                    {% if key_person and key_person.team_member.id not in key_persons|map(attribute='id')|list %}
                        {% set _ = key_persons.append(key_person.team_member) %}
                    {% endif %}
                {% endfor %}
                {% for person in key_persons|sort(attribute='last_name') %}
                    <option value="{{ person.first_name }} {{ person.last_name }}">{{ person.first_name }} {{ person.last_name }}</option>
                {% endfor %}
            </select>
        </div>
        <div>
            <label for="sortUpdate" class="block text-sm font-medium text-gray-700">Sort by Last Update</label>
            <select id="sortUpdate" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                <option value="">Default Order</option>
                <option value="oldest">Oldest First</option>
                <option value="newest">Newest First</option>
            </select>
        </div>
    </div>
</div>

<div class="mt-6">
    <div class="overflow-hidden bg-white shadow sm:rounded-md">
        <table class="min-w-full divide-y divide-gray-200" id="brandsTable">
            <thead class="bg-gray-50">
                <tr>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100" onclick="sortTable('brand')">
                        Brand / Company <i class="fas fa-sort ml-1 text-gray-400"></i>
                    </th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100" onclick="sortTable('keyPerson')">
                        Key Person <i class="fas fa-sort ml-1 text-gray-400"></i>
                    </th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100" onclick="sortTable('riskLevel')">
                        Risk Level <i class="fas fa-sort ml-1 text-gray-400"></i>
                    </th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100" onclick="sortTable('lastUpdate')">
                        Last Update <i class="fas fa-sort ml-1 text-gray-400"></i>
                    </th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100" onclick="sortTable('status')">
                        Status <i class="fas fa-sort ml-1 text-gray-400"></i>
                    </th>
                    <th scope="col" class="relative px-6 py-3"><span class="sr-only">Actions</span></th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                {% for brand in brands %}
                {% set key_person = brand.team_members|selectattr('is_key_responsible', 'equalto', true)|first %}
                {% set latest_update = brand.status_updates|sort(attribute='date', reverse=True)|first %}
                <tr class="hover:bg-gray-50 brand-row" 
                    data-brand-name="{{ brand.name|lower }}"
                    data-company-name="{{ brand.company.name|lower }}"
                    data-subbrands="{% for subbrand in brand.subbrands %}{{ subbrand.name|lower }} {% endfor %}"
                    data-key-person="{% if key_person %}{{ key_person.team_member.first_name }} {{ key_person.team_member.last_name }}{% endif %}"
                    data-update-date="{% if latest_update %}{{ latest_update.date.isoformat() }}{% else %}1900-01-01{% endif %}"
                    data-risk-level="{% if latest_update %}{{ latest_update.evaluation }}{% else %}none{% endif %}"
                    data-status="{{ brand.status }}">
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div>
                            <div class="text-sm font-medium text-gray-900">{{ brand.name }}</div>
                            {% if brand.subbrands %}
                            <div class="text-xs text-gray-500 mt-1">
                                {% for subbrand in brand.subbrands %}
                                    <span class="inline-block">â†’ {{ subbrand.name }}{% if not loop.last %}, {% endif %}</span>
                                {% endfor %}
                            </div>
                            {% endif %}
                            <div class="text-sm text-gray-500">{{ brand.company.name }}</div>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        {% if key_person %}
                            <div class="text-sm text-gray-900">{{ key_person.team_member.first_name }} {{ key_person.team_member.last_name }}</div>
                            <div class="text-sm text-gray-500">{{ key_person.team_member.role.replace('_', ' ').title() }}</div>
                        {% else %}
                            <span class="text-sm text-gray-400">Not assigned</span>
                        {% endif %}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        {% if latest_update %}
                            {% if latest_update.evaluation == 'perfect' %}
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                    <i class="fas fa-check-circle mr-1"></i> Perfect
                                </span>
                            {% elif latest_update.evaluation == 'medium' %}
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">
                                    <i class="fas fa-exclamation-circle mr-1"></i> Medium
                                </span>
                            {% else %}
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">
                                    <i class="fas fa-times-circle mr-1"></i> Risk
                                </span>
                            {% endif %}
                        {% else %}
                            <span class="text-sm text-gray-400">No updates</span>
                        {% endif %}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        {% if latest_update %}
                            {{ latest_update.date.strftime('%Y-%m-%d') }}
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        {% if brand.status == 'active' %}
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                Active
                            </span>
                        {% else %}
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                                Inactive
                            </span>
                        {% endif %}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <a href="{{ url_for('clients.brand_detail', brand_id=brand.id) }}" class="text-indigo-600 hover:text-indigo-900">View</a>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="6" class="px-6 py-4 text-center text-sm text-gray-500">No brands found. Create your first brand to get started.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('search');
    const keyPersonSelect = document.getElementById('keyPerson');
    const sortUpdateSelect = document.getElementById('sortUpdate');
    const tableBody = document.querySelector('#brandsTable tbody');
    const rows = Array.from(document.querySelectorAll('.brand-row'));
    
    function filterAndSortBrands() {
        const searchTerm = searchInput.value.toLowerCase();
        const selectedKeyPerson = keyPersonSelect.value;
        const sortOrder = sortUpdateSelect.value;
        
        // Filter rows
        let visibleRows = rows.filter(row => {
            // Search filter
            const brandName = row.getAttribute('data-brand-name');
            const companyName = row.getAttribute('data-company-name');
            const subbrands = row.getAttribute('data-subbrands');
            const searchMatch = brandName.includes(searchTerm) || 
                              companyName.includes(searchTerm) || 
                              subbrands.includes(searchTerm);
            
            // Key person filter
            const keyPerson = row.getAttribute('data-key-person');
            const keyPersonMatch = !selectedKeyPerson || keyPerson === selectedKeyPerson;
            
            // Show/hide row based on filters
            const shouldShow = searchMatch && keyPersonMatch;
            row.style.display = shouldShow ? '' : 'none';
            
            return shouldShow;
        });
        
        // Sort visible rows
        if (sortOrder) {
            visibleRows.sort((a, b) => {
                const dateA = a.getAttribute('data-update-date');
                const dateB = b.getAttribute('data-update-date');
                
                if (sortOrder === 'oldest') {
                    return dateA.localeCompare(dateB);
                } else {
                    return dateB.localeCompare(dateA);
                }
            });
            
            // Reorder rows in the table
            visibleRows.forEach(row => {
                tableBody.appendChild(row);
            });
        }
        
        // Show "no results" message if needed
        const noResultsRow = document.getElementById('no-results-row');
        if (visibleRows.length === 0) {
            if (!noResultsRow) {
                const newRow = document.createElement('tr');
                newRow.id = 'no-results-row';
                newRow.innerHTML = '<td colspan="6" class="px-6 py-4 text-center text-sm text-gray-500">No brands match your filters.</td>';
                tableBody.appendChild(newRow);
            }
        } else if (noResultsRow) {
            noResultsRow.remove();
        }
    }
    
    // Add event listeners
    searchInput.addEventListener('input', filterAndSortBrands);
    keyPersonSelect.addEventListener('change', filterAndSortBrands);
    sortUpdateSelect.addEventListener('change', filterAndSortBrands);
});

// Sort table columns
let sortOrders = {};

function sortTable(column) {
    const tableBody = document.querySelector('#brandsTable tbody');
    const rows = Array.from(document.querySelectorAll('.brand-row:not([style*="display: none"])'));
    
    // Toggle sort order
    sortOrders[column] = sortOrders[column] === 'asc' ? 'desc' : 'asc';
    
    // Update sort icons
    document.querySelectorAll('th i.fas').forEach(icon => {
        icon.className = 'fas fa-sort ml-1 text-gray-400';
    });
    
    const currentHeader = event.currentTarget.querySelector('i');
    if (sortOrders[column] === 'asc') {
        currentHeader.className = 'fas fa-sort-up ml-1 text-gray-600';
    } else {
        currentHeader.className = 'fas fa-sort-down ml-1 text-gray-600';
    }
    
    // Sort rows
    rows.sort((a, b) => {
        let valueA, valueB;
        
        switch(column) {
            case 'brand':
                valueA = a.getAttribute('data-brand-name');
                valueB = b.getAttribute('data-brand-name');
                break;
            case 'keyPerson':
                valueA = a.getAttribute('data-key-person') || 'zzz';
                valueB = b.getAttribute('data-key-person') || 'zzz';
                break;
            case 'riskLevel':
                const riskOrder = {'perfect': 1, 'medium': 2, 'risk': 3, 'none': 4};
                valueA = riskOrder[a.getAttribute('data-risk-level')] || 4;
                valueB = riskOrder[b.getAttribute('data-risk-level')] || 4;
                return sortOrders[column] === 'asc' ? valueA - valueB : valueB - valueA;
            case 'lastUpdate':
                valueA = a.getAttribute('data-update-date');
                valueB = b.getAttribute('data-update-date');
                break;
            case 'status':
                valueA = a.getAttribute('data-status');
                valueB = b.getAttribute('data-status');
                break;
            default:
                return 0;
        }
        
        // String comparison for most columns
        if (typeof valueA === 'string') {
            if (sortOrders[column] === 'asc') {
                return valueA.localeCompare(valueB);
            } else {
                return valueB.localeCompare(valueA);
            }
        }
        return 0;
    });
    
    // Reorder rows in the table
    rows.forEach(row => {
        tableBody.appendChild(row);
    });
}
</script>
{% endblock %}